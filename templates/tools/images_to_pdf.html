<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>تحويل الصور إلى PDF</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#1b4965] via-[#62b6cb] to-[#e9c46a] text-white">
	<div class="max-w-5xl mx-auto p-6">
		<div class="flex items-center justify-between">
			<h1 class="text-3xl font-extrabold">تحويل الصور إلى ملف PDF</h1>
			<a href="/tools" class="rounded-lg bg-white/90 text-[#1b4965] px-4 py-2 font-semibold">العودة للأدوات</a>
		</div>

		<div class="mt-6 bg-white/10 border border-white/20 rounded-2xl p-6">
			<form id="form" class="space-y-4" onsubmit="return false;">
				<div>
					<label class="block mb-1">رفع الصور (JPEG, PNG) — يمكنك اختيار عدة صور</label>
					<input id="images" type="file" accept="image/*" multiple class="block w-full text-black rounded" />
					<p id="meta" class="text-white/80 text-sm mt-2 hidden"></p>
				</div>

				<div>
					<label class="block mb-1">الصور المختارة (اسحب لإعادة الترتيب)</label>
					<ul id="thumbs" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3"></ul>
				</div>

				<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
					<div>
						<label class="block mb-1">حجم الصفحة</label>
						<select id="page_size" class="w-full rounded px-3 py-2 text-black">
							<option value="A4">A4</option>
							<option value="LETTER">Letter</option>
						</select>
					</div>
					<div class="sm:col-span-2">
						<label class="block mb-1">الترتيب الحالي</label>
						<input id="order" type="text" class="w-full rounded px-3 py-2 text-black" placeholder="مثال: 2,1,3" />
					</div>
				</div>

				<button id="submit" class="rounded-xl bg-[#e9c46a] text-[#7a3b2e] font-bold px-6 py-3">تحويل إلى PDF</button>
			</form>

			<div id="result" class="mt-4 hidden">
				<a id="download" class="rounded-xl bg-white text-[#1b4965] font-semibold px-4 py-2" href="#">تنزيل الملف</a>
				<span id="outname" class="ml-3 text-white/90"></span>
			</div>
			<div id="alert" class="mt-4 hidden rounded bg-red-500/20 border border-red-400/40 p-3"></div>
		</div>
	</div>

	<script>
		const images = document.getElementById('images');
		const thumbs = document.getElementById('thumbs');
		const order = document.getElementById('order');
		const pageSize = document.getElementById('page_size');
		const meta = document.getElementById('meta');
		const result = document.getElementById('result');
		const download = document.getElementById('download');
		const outname = document.getElementById('outname');
		const alertBox = document.getElementById('alert');
		function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hidden'); }
		function hideError(){ alertBox.classList.add('hidden'); alertBox.textContent=''; }

		let list = [];
		function refreshOrder(){
			const idxs = Array.from(thumbs.children).map(li => li.dataset.idx);
			order.value = idxs.join(',');
		}
		new Sortable(thumbs, { animation: 150, onSort: refreshOrder });

		images.addEventListener('change', () => {
			thumbs.innerHTML = ''; list = [];
			let totalSize = 0;
			Array.from(images.files).forEach((f, i) => {
				const url = URL.createObjectURL(f);
				const li = document.createElement('li');
				li.className = 'rounded overflow-hidden bg-white/90 text-black';
				li.dataset.idx = (i+1).toString();
				li.innerHTML = `<img src="${url}" class="w-full h-24 object-cover" /><div class="px-2 py-1 text-xs truncate">${f.name}</div>`;
				thumbs.appendChild(li);
				totalSize += f.size;
				list.push(f);
			});
			order.value = Array.from({length: list.length}, (_, i) => i+1).join(',');
			meta.textContent = `الصور: ${list.length} — الحجم الإجمالي: ${(totalSize/1024/1024).toFixed(2)}MB`;
			meta.classList.remove('hidden');
		});

		document.getElementById('submit').addEventListener('click', async () => {
			hideError(); result.classList.add('hidden');
			const fd = new FormData();
			for (const f of images.files) fd.append('images', f);
			fd.append('order', order.value.trim());
			fd.append('page_size', pageSize.value);
			try {
				const res = await fetch('/api/images-to-pdf', { method:'POST', body: fd });
				const data = await res.json();
				if(!res.ok || !data.success) throw new Error(data.error||'فشل التحويل');
				download.href = data.url; outname.textContent = data.filename || '';
				result.classList.remove('hidden');
			} catch(e){ showError(e.message); }
		});
	</script>
</body>
</html>
